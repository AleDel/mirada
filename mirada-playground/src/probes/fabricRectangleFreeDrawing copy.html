<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge'>
  <title>Page Title</title>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <script src="../../node_modules/fabric/dist/fabric.js"></script>
</head>

<body>
  <label>rectangle free draw <input type="checkbox" id="checkbox"></label>
  <canvas id="canvas" width="500" height="500" style="margin-left: 200px; margin-top: 200px; border: 2px solid black"></canvas>

  <script>
    const canvas = document.querySelector('#canvas')
    var fabricCanvas = new fabric.Canvas(canvas);
    const checkbox = document.querySelector('#checkbox')
    var freeDrawing = false;
    var dragging = false;
    var rect;
    function onMouseDown(e) {
      dragging = true;
      // debugger
      if (freeDrawing) {
        initialPos = {
           left: e.e.pageX - canvas.offsetLeft,
          top: e.e.pageY - canvas.offsetTop,
        }
        rect = new fabric.Rect({
         ...initialPos,
          width: 0, height: 0,
          stroke: 'red',          strokeWidth: 3, fill: ''
        });
        fabricCanvas.add(rect);
      }
    }
    function onMouseMove(e) {
      if (dragging && freeDrawing) {
        rect.width = Math.abs(e.e.clientX - canvas.offsetLeft - rect.left)
        rect.height = Math.abs(e.e.clientY - canvas.offsetTop - rect.top)
        fabricCanvas.renderAll();
      }
    }
    function onMouseUp(e) {
      if (freeDrawing) {
        dragging = false;
        fabricCanvas.add();
      }
    }
    checkbox.addEventListener('change', e => {
      if (e.currentTarget.checked) {
        freeDrawing = true; dragging = false; rect = null
        fabricCanvas.on('mouse:down', onMouseDown);
        fabricCanvas.on('mouse:move', onMouseMove);
        fabricCanvas.on('mouse:up', onMouseUp);
      } else {
        freeDrawing = false; dragging = false; rect = null
        fabricCanvas.off('mouse:down', onMouseDown);
        fabricCanvas.off('mouse:move', onMouseMove);
        fabricCanvas.off('mouse:up', onMouseUp);
      }
    })

  </script>
</body>

</html>